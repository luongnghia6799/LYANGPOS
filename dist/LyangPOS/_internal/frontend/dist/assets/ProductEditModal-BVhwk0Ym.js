import{r as c,j as e}from"./vendor-C23Namvk.js";import{a as j}from"./vendor-utils-C44aPrMG.js";import{P as L,d as N}from"./index-DXxzNUOO.js";import{T as S}from"./Toast-rpGoMLC9.js";import{A as y,m as h}from"./vendor-framer-DVZK1f_z.js";import{X as D,_ as P,O as A,a1 as q}from"./vendor-icons-C8Df64wb.js";const w=({value:o,onChange:m,placeholder:d,className:f,...x})=>{const[s,i]=c.useState("");c.useEffect(()=>{o!=null&&i(N(o))},[o]);const b=u=>{const l=u.target.value.replace(/,/g,"");isNaN(l)||(m(l===""?0:parseFloat(l)),i(l===""?"":N(l)))};return e.jsx("input",{type:"text",value:s,onChange:b,placeholder:d,className:`input-premium ${f}`,autoComplete:"off",...x})};function V({product:o,isOpen:m,onClose:d,onSave:f}){const x={name:"",code:"",unit:"Cái",secondary_unit:"",multiplier:1,cost_price:0,sale_price:0,stock:0,expiry_date:"",active_ingredient:"",brand:"",is_combo:!1,combo_items:[]},[s,i]=c.useState(x),[b,u]=c.useState(null),[l,v]=c.useState([]),[g,k]=c.useState("");c.useEffect(()=>{m&&i(o?t=>o.id&&t.id===o.id?t:{...x,...o,combo_items:o.combo_items||[]}:x)},[m]),c.useEffect(()=>{m&&o&&o.id&&o.id!==s.id&&i({...x,...o,combo_items:o.combo_items||[]})},[o]),c.useEffect(()=>{m&&s.is_combo&&C()},[m,s.is_combo]),c.useEffect(()=>{const t=a=>{a.key==="Escape"&&m&&d()};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[m,d]),c.useEffect(()=>{if(s.is_combo&&s.combo_items.length>0&&l.length>0){let t=0,a=[];s.combo_items.forEach(n=>{const r=l.find(p=>p.id===n.product_id);r&&(t+=(r.cost_price||0)*(n.quantity||0),a.push(Math.floor((r.stock||0)/(n.quantity||1))))}),i(n=>({...n,cost_price:t,stock:a.length>0?Math.min(...a):0}))}},[s.combo_items,s.is_combo,l]);const C=async()=>{try{let a=(await j.get("/api/products")).data;if(a.items&&Array.isArray(a.items)&&(a=a.items),Array.isArray(a)){const n=a.sort((r,p)=>(r.name||"").localeCompare(p.name||"","vi",{sensitivity:"base"}));v(n)}else console.error("Invalid products data format",a),v([])}catch(t){console.error(t)}},_=async t=>{o?.id?await j.put(`/api/products/${o.id}`,t):await j.post("/api/products",t)},T=async t=>{t.preventDefault();try{await _(s),f(),d()}catch(a){console.error(a),u({message:a.response?.data?.error||"Lỗi khi lưu sản phẩm.",type:"error"})}},E=async t=>{if(t.preventDefault(),!s.name){u({message:"Vui lòng nhập tên sản phẩm",type:"error"});return}try{await _(s),f(),i({name:"",code:"",unit:"Cái",secondary_unit:"",multiplier:1,cost_price:0,sale_price:0,stock:0,expiry_date:"",active_ingredient:"",brand:"",is_combo:!1,combo_items:[]}),setTimeout(()=>document.getElementById("prod-name-input")?.focus(),100),u({message:"Đã lưu sản phẩm!",type:"success"})}catch(a){console.error(a),u({message:a.response?.data?.error||"Lỗi khi lưu sản phẩm.",type:"error"})}};return e.jsx(L,{children:e.jsxs(y,{children:[m&&e.jsxs(h.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 z-[2000] flex items-center justify-center p-4 overflow-y-auto",children:[e.jsx(h.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black/60 backdrop-blur-sm",onClick:d}),e.jsxs(h.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},transition:{type:"spring",stiffness:200,damping:25,mass:.8},className:"bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl w-full max-w-2xl p-8 border dark:border-slate-800 transition-colors my-auto relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsx("h2",{className:"text-2xl font-black text-gray-800 dark:text-gray-100 uppercase tracking-tighter",children:o?.id?"Sửa sản phẩm":"Thêm sản phẩm mới"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 bg-blue-50 dark:bg-blue-900/20 px-3 py-1.5 rounded-xl cursor-pointer hover:bg-blue-100 border border-blue-100 dark:border-blue-800",children:[e.jsx("input",{type:"checkbox",className:"w-4 h-4",checked:s.is_combo,onChange:t=>i({...s,is_combo:t.target.checked,combo_items:t.target.checked?s.combo_items||[]:[]}),autoComplete:"off"}),e.jsx("span",{className:"text-xs font-black uppercase text-primary",children:"Sản phẩm Combo"})]}),e.jsx("button",{onClick:d,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200",children:e.jsx(D,{size:24})})]})]}),e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:"Tên sản phẩm"}),e.jsx("input",{required:!0,id:"prod-name-input",type:"text",className:"input-premium w-full p-3 uppercase font-bold",value:s.name,onChange:t=>i({...s,name:t.target.value}),autoComplete:"off"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:"Mã sản phẩm / Combo"}),e.jsx("input",{type:"text",className:"input-premium w-full p-3 font-bold",value:s.code||"",onChange:t=>i({...s,code:t.target.value}),autoComplete:"off"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:"Hoạt chất / Thành phần"}),e.jsx("input",{type:"text",className:"input-premium w-full p-3 font-bold",value:s.active_ingredient||"",onChange:t=>i({...s,active_ingredient:t.target.value}),autoComplete:"off"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:"Hãng / Thương hiệu"}),e.jsx("input",{type:"text",className:"input-premium w-full p-3 font-bold",value:s.brand||"",onChange:t=>i({...s,brand:t.target.value}),autoComplete:"off"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:"Đơn vị"}),e.jsx("input",{type:"text",className:"input-premium w-full p-3 uppercase font-bold",value:s.unit,list:"unit-list",onChange:t=>i({...s,unit:t.target.value}),autoComplete:"off"}),e.jsxs("datalist",{id:"unit-list",children:[e.jsx("option",{value:"Cái"}),e.jsx("option",{value:"Chiếc"}),e.jsx("option",{value:"Hộp"}),e.jsx("option",{value:"Thùng"}),e.jsx("option",{value:"Chai"}),e.jsx("option",{value:"Lọ"}),e.jsx("option",{value:"Gói"}),e.jsx("option",{value:"Kg"}),e.jsx("option",{value:"Gram"}),e.jsx("option",{value:"Lít"}),e.jsx("option",{value:"Ml"}),e.jsx("option",{value:"Viên"}),e.jsx("option",{value:"Vỉ"}),e.jsx("option",{value:"Túi"}),e.jsx("option",{value:"Cuộn"}),e.jsx("option",{value:"Mét"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:["Tồn kho ",s.is_combo&&e.jsx("span",{className:"text-[10px] text-blue-500 font-bold",children:"(Tự tính)"})]}),e.jsx("input",{required:!0,type:"number",disabled:s.is_combo,className:"input-premium w-full p-3 font-bold disabled:opacity-50",value:s.stock,onChange:t=>i({...s,stock:parseInt(t.target.value)||0}),autoComplete:"off"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:"Hạn sử dụng"}),e.jsx("input",{type:"date",className:"input-premium w-full p-3 font-bold",value:s.expiry_date||"",onChange:t=>i({...s,expiry_date:t.target.value}),autoComplete:"off"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:["Giá vốn ",s.is_combo&&e.jsx("span",{className:"text-[10px] text-blue-500 font-bold",children:"(Tự tính)"})]}),e.jsx(w,{disabled:s.is_combo,className:"w-full p-3 font-bold disabled:opacity-50",value:s.cost_price,onChange:t=>i({...s,cost_price:t})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-500 mb-2",children:"Giá bán"}),e.jsx(w,{className:"w-full p-3 font-black text-xl text-primary",value:s.sale_price,onChange:t=>i({...s,sale_price:t})}),s.sale_price<s.cost_price&&e.jsx("div",{className:"text-red-500 text-[10px] font-black uppercase mt-1",children:"Cảnh báo: Giá bán thấp hơn giá nhập!"})]})]}),s.is_combo?e.jsxs("div",{className:"border dark:border-slate-700 rounded-2xl p-4 bg-gray-50 dark:bg-slate-800/30",children:[e.jsx("label",{className:"block text-xs font-black uppercase text-primary mb-4",children:"Sản phẩm trong combo (Gõ vào ô search để tìm hàng)"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("input",{type:"text",className:"input-premium w-full p-3 text-xs font-bold",style:{paddingLeft:"2.5rem"},placeholder:"Tìm kiếm sản phẩm để thêm vào combo...",value:g,onChange:t=>k(t.target.value),autoComplete:"off"}),e.jsx("div",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),e.jsx(y,{children:g&&e.jsx(h.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},transition:{type:"spring",stiffness:300,damping:25},className:"dropdown-premium mt-1 max-h-40 overflow-y-auto no-scrollbar overflow-x-hidden",children:e.jsx("div",{className:"py-0",children:e.jsx(y,{mode:"popLayout",children:l.filter(t=>!t.is_combo&&(t.name||"").toLowerCase().includes(g.toLowerCase())).map((t,a)=>e.jsxs(h.button,{type:"button",initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,scale:.9},transition:{delay:a*.02,duration:.15},onMouseDown:n=>{n.preventDefault(),s.combo_items.some(r=>r.product_id===t.id)||i({...s,combo_items:[...s.combo_items,{product_id:t.id,quantity:1,unit:t.unit}]}),k("")},className:"dropdown-item w-full text-left p-3 text-xs font-bold",children:[t.name," (",t.unit,")"]},t.id))})})})})]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto pr-2",children:s.combo_items.map((t,a)=>{const n=l.find(r=>r.id===t.product_id);return e.jsxs("div",{className:"flex gap-2 items-center bg-white dark:bg-slate-900 p-2 rounded-lg border dark:border-slate-700",children:[e.jsx("span",{className:"flex-1 text-xs font-bold uppercase",children:n?.name||"Sản phẩm"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-16 text-center border dark:border-slate-700 dark:bg-slate-800 dark:text-white rounded text-xs font-black p-1",value:t.quantity,onChange:r=>{const p=[...s.combo_items];p[a].quantity=parseFloat(r.target.value)||1,i({...s,combo_items:p})},autoComplete:"off"}),e.jsx("span",{className:"text-[10px] font-bold text-gray-500 w-10",children:n?.unit||""})]}),e.jsx("button",{type:"button",onClick:()=>i({...s,combo_items:s.combo_items.filter((r,p)=>p!==a)}),className:"text-red-500 hover:bg-red-50 p-1 rounded-lg transition-colors",children:e.jsx(P,{size:16})})]},a)})}),e.jsxs("div",{className:"mt-2 text-[10px] text-gray-400 font-bold uppercase tracking-tight",children:["Gợi ý: ",l.filter(t=>!t.is_combo&&!s.combo_items.some(a=>a.product_id===t.id)).slice(0,3).map(t=>e.jsxs("button",{type:"button",onMouseDown:a=>{a.preventDefault(),i({...s,combo_items:[...s.combo_items,{product_id:t.id,quantity:1,unit:t.unit}]})},className:"mr-2 hover:text-primary transition-colors",children:["+ ",t.name]},t.id))]})]}):e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-blue-600 mb-2",children:"Đơn vị phụ"}),e.jsx("input",{type:"text",className:"input-premium w-full p-3 font-bold",value:s.secondary_unit||"",list:"unit-list",onChange:t=>i({...s,secondary_unit:t.target.value}),autoComplete:"off"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-blue-600 mb-2",children:"Quy cách"}),e.jsx("input",{type:"number",className:"input-premium w-full p-3 font-bold",value:s.multiplier||1,onChange:t=>i({...s,multiplier:parseFloat(t.target.value)||1}),autoComplete:"off"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[e.jsx("button",{type:"button",onClick:d,className:"px-6 py-3 text-gray-400 font-black uppercase text-xs hover:text-gray-600",children:"Hủy"}),!o?.id&&e.jsxs("button",{type:"button",onClick:E,className:"px-6 py-3 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-xl font-black uppercase text-xs hover:bg-emerald-200 transition-all flex items-center gap-2",children:[e.jsx(A,{size:16})," Lưu & Thêm tiếp"]}),e.jsxs("button",{type:"submit",className:"px-8 py-3 bg-primary text-white rounded-xl font-black uppercase text-xs shadow-xl shadow-blue-500/20 shadow-lg flex items-center gap-2",children:[e.jsx(q,{size:16})," Lưu sản phẩm"]})]})]})]})]}),e.jsx(y,{children:b&&e.jsx(S,{message:b.message,type:b.type,onClose:()=>u(null)})})]})})}export{V as P};
